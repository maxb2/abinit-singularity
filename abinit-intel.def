# Copyright (c) 2020 Intel Corporation.
# SPDX-License-Identifier: BSD-3-Clause

Bootstrap: docker
From: intel/oneapi-hpckit:devel-ubuntu18.04


Stage: build

%environment
  MPI_PROCS=1

%post
  # Build-time variables
  ABINIT_VERSION=9.0.4
  MAKE_PROCS=4
  MPI_PROCS=4
  PY_THREADS=1

  apt-get install -y curl m4 zlib1g-dev

  # Fetch abinit-8.10.3
  cd /opt
  curl -RLO https://www.abinit.org/sites/default/files/packages/abinit-${ABINIT_VERSION}.tar.gz
  tar -xvzf abinit-${ABINIT_VERSION}.tar.gz
  mv abinit-${ABINIT_VERSION} abinit

  # Compile abinit
  mkdir -p abinit/build
  #mv build-config.ac9 abinit/build/
  cd abinit/build
  FC='mpiifort' CC='mpiicc' CXX='mpiicpc' ../configure --with-mpi="yes" \
  --with-linalg-flavor="mkl" \
  --with-fft-flavor="dfti" || true

  cd fallbacks
  ./build-abinit-fallbacks.sh

  cd ..
  FC='mpiifort' CC='mpiicc' CXX='mpiicpc' H5CC="/opt/abinit/build/fallbacks/install_fb/intel/2021.1/hdf5/1.10.6/bin/h5pcc" \
  ../configure --with-mpi="yes" \
  --with-linalg-flavor="mkl" \
  --with-fft-flavor="dfti" \
  --with-libxc='/opt/abinit/build/fallbacks/install_fb/intel/2021.1/libxc/default' \
  --with-hdf5='/opt/abinit/build/fallbacks/install_fb/intel/2021.1/hdf5/default' \
  --with-netcdf='/opt/abinit/build/fallbacks/install_fb/intel/2021.1/netcdf4/default' \
  --with-netcdf-fortran='/opt/abinit/build/fallbacks/install_fb/intel/2021.1/netcdf4_fortran/default'




  make -j${MAKE_PROCS}

  # Test build
  #make check
  #cd ../tests
  #./runtests.py -j ${PY_THREADS} -n ${MPI_PROCS} -b ../build

  # Install
  make install

%runscript
  mpirun -n ${MPI_PROCS} abinit $*

%labels
  Author Matthew Anderson
  Email maxb2@mail.missouri.edu
  Source https://github.com/maxb2/abinit-singularity
  Version v0.0.1
